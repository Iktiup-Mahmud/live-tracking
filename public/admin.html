<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Seyam's Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(0, 12, 24, 0.95);
        border-radius: 15px;
        margin-top: 100px;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .dashboard-card {
        background: rgba(0, 20, 40, 0.8);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #00d4ff;
      }
      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #00d4ff;
        font-family: "Orbitron", monospace;
      }
      .stat-label {
        font-size: 1rem;
        color: #aaa;
        margin-top: 5px;
      }
      .visits-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      .visits-table th,
      .visits-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      }
      .visits-table th {
        background: rgba(0, 212, 255, 0.1);
        font-weight: bold;
        color: #00d4ff;
      }
      .refresh-btn {
        padding: 10px 20px;
        background: #00d4ff;
        color: #000;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 20px;
      }
      .refresh-btn:hover {
        background: #00a8cc;
      }
      .back-btn {
        display: inline-block;
        margin-bottom: 20px;
        padding: 10px 20px;
        background: #666;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        margin-right: 10px;
      }
      .back-btn:hover {
        background: #555;
      }
      .loading {
        text-align: center;
        color: #00d4ff;
        font-size: 1.2rem;
      }
      .error {
        color: #ff4444;
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <i class="fas fa-bolt"></i>
        Seyam's Tracker - Admin Dashboard
      </div>
      <div class="status-indicator">
        <div class="pulse-ring"></div>
        <span class="status-text">ADMIN</span>
      </div>
    </header>

    <div class="dashboard-container">
      <a href="/" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Tracker
      </a>
      <button onclick="refreshData()" class="refresh-btn">
        <i class="fas fa-refresh"></i> Refresh Data
      </button>

      <h1><i class="fas fa-chart-bar"></i> Analytics Dashboard</h1>

      <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading analytics data...
      </div>

      <div id="dashboard-content" style="display: none">
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <i
              class="fas fa-users"
              style="font-size: 2rem; color: #00d4ff; margin-bottom: 10px"
            ></i>
            <div class="stat-number" id="total-visits">--</div>
            <div class="stat-label">Total Visits</div>
          </div>

          <div class="dashboard-card">
            <i
              class="fas fa-map-marker-alt"
              style="font-size: 2rem; color: #00ff00; margin-bottom: 10px"
            ></i>
            <div class="stat-number" id="total-locations">--</div>
            <div class="stat-label">Location Updates</div>
          </div>

          <div class="dashboard-card">
            <i
              class="fas fa-clock"
              style="font-size: 2rem; color: #ffaa00; margin-bottom: 10px"
            ></i>
            <div class="stat-number" id="recent-visits">--</div>
            <div class="stat-label">Visits (24h)</div>
          </div>

          <div class="dashboard-card">
            <i
              class="fas fa-database"
              style="font-size: 2rem; color: #ff6600; margin-bottom: 10px"
            ></i>
            <div class="stat-number" id="mongodb-status">--</div>
            <div class="stat-label">Database Status</div>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><i class="fas fa-list"></i> Recent Visits</h3>
          <div id="recent-visits-table">Loading recent visits...</div>
        </div>
      </div>

      <div id="error-message" class="error" style="display: none"></div>
    </div>

    <script>
      // Load analytics data on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadAnalytics();
      });

      async function loadAnalytics() {
        try {
          document.getElementById("loading").style.display = "block";
          document.getElementById("dashboard-content").style.display = "none";
          document.getElementById("error-message").style.display = "none";

          const response = await fetch("/admin/analytics");
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Update statistics
          document.getElementById("total-visits").textContent =
            data.totalVisits || 0;
          document.getElementById("total-locations").textContent =
            data.totalLocations || 0;
          document.getElementById("recent-visits").textContent =
            data.recentVisitsCount || 0;
          document.getElementById("mongodb-status").textContent =
            data.mongodb || "Unknown";

          // Update recent visits table
          updateRecentVisitsTable(data.recentVisits || []);

          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard-content").style.display = "block";
        } catch (error) {
          console.error("Failed to load analytics:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("error-message").style.display = "block";
          document.getElementById("error-message").innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h3>
                    <p>${error.message}</p>
                    <p>Make sure your MongoDB connection is configured properly in Vercel environment variables.</p>
                `;
        }
      }

      function updateRecentVisitsTable(visits) {
        const tableContainer = document.getElementById("recent-visits-table");

        if (!visits || visits.length === 0) {
          tableContainer.innerHTML = "<p>No recent visits found.</p>";
          return;
        }

        const table = `
                <table class="visits-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Page</th>
                            <th>IP</th>
                            <th>Browser</th>
                            <th>OS</th>
                            <th>Device</th>
                            <th>Country</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${visits
                          .map(
                            (visit) => `
                            <tr>
                                <td>${new Date(
                                  visit.timestamp
                                ).toLocaleString()}</td>
                                <td>${visit.page || "/"}</td>
                                <td>${visit.ip || "Unknown"}</td>
                                <td>${visit.browser || "Unknown"}</td>
                                <td>${visit.os || "Unknown"}</td>
                                <td>${visit.device || "Unknown"}</td>
                                <td>${visit.country || "Unknown"}</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        tableContainer.innerHTML = table;
      }

      function refreshData() {
        loadAnalytics();
      }

      // Auto-refresh every 30 seconds
      setInterval(refreshData, 30000);
    </script>
  </body>
</html>
